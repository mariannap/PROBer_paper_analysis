#!/usr/bin/env python

from sys import argv, exit
import numpy

if len(argv) < 6 or len(argv) > 7:
	print("Usage: beta2shape input.[beta/score] output.shape tid(1-based) first_n_nt total_len [gt_pos.txt]")
	exit(-1)
	
#5%-10% normalization
def calc_norm_factor(data):
    sorted(data, reverse = True)
    s = len(data)
    fr = int(float(s) / 100.0 * 5.0)
    to = int(float(s) / 100.0 * 15.0)
    return numpy.mean(data[fr:to])


isBeta = argv[1][argv[1].rindex('.') + 1:] == "beta"
tid = int(argv[3])
firstn = int(argv[4])
totlen = int(argv[5])

with open(argv[1]) as fin:
	for i in range(tid if isBeta else tid - 1):
		fin.readline()
	start = 2 if isBeta else 0
	data = [float(x) for x in fin.readline().strip().split()[start : start + firstn]]
	factor = calc_norm_factor(data)
	data = [x / factor for x in data]

validPos = [1] * totlen
if len(argv) == 7:
	with open(argv[6]) as fin:
		validPos = [int(x) for x in fin.readline().strip().split()]

with open(argv[2], "w") as fout:
	for i, x in enumerate(data):
		fout.write("{0}\t{1}\n".format(i + 1, x if validPos[i] == 1 else -999))
	for i in range(firstn + 1, totlen + 1):
		fout.write("{0}\t-999\n".format(i))
